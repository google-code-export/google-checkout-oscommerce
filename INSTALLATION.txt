HOW TO INSTALL GOOGLE CHECKOUT MODULE FOR OSC

If you haven't read README.txt yet, please read it first.

NOTE: This is meant to work with: 
  osCommerce Online Merchant v2.2, Release Candidate 2a.
  
Please see:
  http://www.oscommerce.com/solutions/downloads
  
IMPORTANT: Uninstall and re install the module. If not, many new configuration 
 will not be enabled.

This file describes how to perform a fresh install of the Google Checkout
 Module. There are several possible ways to install the module:
  
  I. Installer Script
  II. Manual Installation
    A. Unmodified osCommerce
    B. Modified osCommerce

--------------------------------------------------------------------------------

I. INSTALLER SCRIPT
===================

You can install the module by running install.sh from the root directory of the
 unzipped Google Checkout Module (i.e., the directory that contains the script).
 
To install, execute:

  ./install.sh install path/to/your/oscommerce

The osCommerce directory you specify should be teh one that contains the
 'catalog' directory.
 
To uninstall, execute:

  ./install.sh uninstall path/to/your/oscommerce
 
The install command creates backups of any files it modifies, so you can use
 the uninstall to revert all those changes.
 
If you use the install script on a modified version of osCommerce, it may
 run into problems when attempting to merge changes. If this happens, the script
 will tell you which files need to be manually edited. You can always run
 uninstall to revert all the changes, or you can manually correct the failed
 merges using your favorite text editor.
 
II. MANUAL INSTALLATION 
=======================

There are two installation options you need to choose from, so please read
 carefully to determine which option is right for you.

A. UNMODIFIED OSCOMMERCE
========================

If you have the basic osCommerce installation without any other modules or
 add-on's, simply copy the provided files into your osCommerce system,
 preserving the file structure. 

 For your reference, here is the list of files you need to copy over to your
 system:

  OSC_DIR:
    CHANGELOG.txt
    install.sh
    INSTALLATION.txt
    README.txt
    states.jpg
    UPGRADE.txt
    
  OSC_DIR/catalog:
    checkout_payment.php
    gc_return.php
    login.php
    shopping_cart.php
    
  OSC_DIR/catalog/admin:
    htaccess.php
    modules.php
    orders.php
    
  OSC_DIR/catalog/admin/includes/functions:
    general.php
    
  OSC_DIR/catalog/googlecheckout:
    gcheckout.php
    index.html
    responsehandler.php
    shipping_methods_ccs.php
    shipping_methods.php
    
  OSC_DIR/catalog/googlecheckout/library:
    googlecart.php
    googleitem.php
    googlelog.php
    googlemerchantcalculations.php
    googlerequest.php
    googleresponse.php
    googleresult.php
    googleshipping.php
    googletax.php
    index.html
    
  OSC_DIR/catalog/googlecheckout/library/xml-processing:
    gc_xmlbuilder.php
    gc_xmlparser.php
    index.html
    
  OSC_DIR/catalog/googlecheckout/logs:
    index.html
    response_error.log
    response_message.log
    
  OSC_DIR/catalog/googlecheckout/shipping_generator:
    index.php
    multigenerator.php
    multishipping_generator.js
    multishipping_generator.php
    README
    shipping_method_generator.php
    
  OSC_DIR/catalog/googlecheckout/shipping_metrics:
    readme
    ship_metrics
    shipping_metrics_commandline.php
    shipping_metrics.log
    
  OSC_DIR/catalog/includes/languages/english/modules/payment:
    googlecheckout.php
    
  OSC_DIR/catalog/includes/languages/espanol/modules/payment:
    googlecheckout.php
    
  OSC_DIR/catalog/includes/languages/german/modules/payment:
    googlecheckout.php
    
  OSC_DIR/catalog/includes/modules/payment:
    googlecheckout.php


* Note: If you applied a patch or manually modified the files to disable 
   register_globals, go for Option B.

B. MODIFIED OSCOMMERCE
======================

If you have other modules installed on your osCommerce installation, replacing 
 your existing files might break your existing installation. In this case, you 
 need to edit the existing files manually.

 For this option, follow the instructions below:

 I. Copy the following new files into your existing system, preserving the file structure:
 -----------------------------------------------------------------------------------------

  OSC_DIR:
    CHANGELOG.txt
    install.sh
    INSTALLATION.txt
    README.txt
    states.jpg
    UPGRADE.txt
    
  OSC_DIR/catalog:
    gc_return.php
    
  OSC_DIR/catalog/admin:
    htaccess.php
    
  OSC_DIR/catalog/googlecheckout:
    gcheckout.php
    index.html
    responsehandler.php
    shipping_methods_ccs.php
    shipping_methods.php
    
  OSC_DIR/catalog/googlecheckout/library:
    googlecart.php
    googleitem.php
    googlelog.php
    googlemerchantcalculations.php
    googlerequest.php
    googleresponse.php
    googleresult.php
    googleshipping.php
    googletax.php
    index.html
    
  OSC_DIR/catalog/googlecheckout/library/xml-processing:
    gc_xmlbuilder.php
    gc_xmlparser.php
    index.html
    
  OSC_DIR/catalog/googlecheckout/logs:
    index.html
    response_error.log
    response_message.log
    
  OSC_DIR/catalog/googlecheckout/shipping_generator:
    index.php
    multigenerator.php
    multishipping_generator.js
    multishipping_generator.php
    README
    shipping_method_generator.php
    
  OSC_DIR/catalog/googlecheckout/shipping_metrics:
    readme
    ship_metrics
    shipping_metrics_commandline.php
    shipping_metrics.log
    
  OSC_DIR/catalog/includes/languages/english/modules/payment:
    googlecheckout.php
    
  OSC_DIR/catalog/includes/languages/espanol/modules/payment:
    googlecheckout.php
    
  OSC_DIR/catalog/includes/languages/german/modules/payment:
    googlecheckout.php
    
  OSC_DIR/catalog/includes/modules/payment:
    googlecheckout.php


 II. Manually edit the following files from your system as instructed below:
 ---------------------------------------------------------------------------
 
  OSC_DIR/catalog/admin/includes/functions:
    general.php
    
	OSC_DIR/catalog/admin:
    modules.php
  	orders.php

	OSC_DIR/catalog:
		checkout_payment.php
		login.php
		shopping_cart.php

  ----------------------------------------------------------------------------
  1. /catalog/admin/includes/functions/general.php                    LINE 759
  ============================================================================
  ADD:
  
  // *** BEGIN GOOGLE CHECKOUT ***
  require_once(DIR_FS_CATALOG . 'googlecheckout/inserts/admin/includes/functions/general.php');
  // *** END GOOGLE CHECKOUT ***
    

  ----------------------------------------------------------------------------
  2a. /catalog/admin/modules.php                                       LINE 45
  ============================================================================
  
  REPLACE:

      case 'save':
        while (list($key, $value) = each($HTTP_POST_VARS['configuration'])) {
          tep_db_query("update " . TABLE_CONFIGURATION . " set configuration_value = '" . $value . "' where configuration_key = '" . $key . "'");
        }
        tep_redirect(tep_href_link(FILENAME_MODULES, 'set=' . $set . '&module=' . $HTTP_GET_VARS['module']));
        break;

  WITH:

      case 'save':
        // *** BEGIN GOOGLE CHECKOUT ***
        // TODO(eddavisson): Investigate this change.
        // fix configuration no saving -
        reset($HTTP_POST_VARS['configuration']);
        // end fix    
        while (list($key, $value) = each($HTTP_POST_VARS['configuration'])) {
          // Checks if module is of type google checkout and also verfies if this configuration is 
          // for the check boxes for the shipping options           
          if (is_array($value)) {
            $value = implode(", ", $value);
            $value = ereg_replace (", --none--", "", $value);
          }
          // Change this query to use gc_makeSqlString()
          tep_db_query("update " . TABLE_CONFIGURATION . " set configuration_value = " . gc_makeSqlString($value) . " where configuration_key = " . gc_makeSqlString($key));
        }
        // *** END GOOGLE CHECKOUT ***
        tep_redirect(tep_href_link(FILENAME_MODULES, 'set=' . $set . '&module=' . $HTTP_GET_VARS['module']));
        break;


  ----------------------------------------------------------------------------
  2b. /catalog/admin/modules.php                                       LINE 15
  ============================================================================

  ADD:

  // *** BEGIN GOOGLE CHECKOUT ***
  function gc_makeSqlString($str) {
    $single_quote = "'";
    $escaped_str = addcslashes(stripcslashes($str), "'\"\\\0..\37!@\177..\377");
    return ($single_quote.$escaped_str.$single_quote);
  }
  // *** END GOOGLE CHECKOUT ***


  ----------------------------------------------------------------------------
  3a. /catalog/admin/orders.php                                       LINE 318
  ============================================================================
  
  REPLACE:
  
            </table></td>
            <td valign="top"><?php echo tep_image_submit('button_update.gif', IMAGE_UPDATE); ?></td>
          </tr>
        </table></td>
 
  WITH:
  
            </table></td>
            <td valign="top"><?php echo tep_image_submit('button_update.gif', IMAGE_UPDATE); ?></td>
<!-- *** BEGIN GOOGLE CHECKOUT *** -->
<?php 
// Google Checkout Tracking Number
//orders_status == STATE_PROCESSING -> Processing before delivery
  if(strpos($order->info['payment_method'], 'Google')!= -1 && $order->info['orders_status'] == GC_STATE_PROCESSING){
      echo '<td><table border="0" cellpadding="3" cellspacing="0" width="100%">   
        <tbody>
          <tr>  
            <td style="border-top: 2px solid rgb(255, 255, 255); border-right: 2px solid rgb(255, 255, 255);" nowrap="nowrap" colspan="2">
                <b>Shipping Information</b>  
            </td>  
          </tr>
          <tr>  
            <td nowrap="nowrap" valign="middle" width="1%">  
              <font size="2">  
                <b>Tracking:</b>  
              </font>  
            </td>  
            <td style="border-right: 2px solid rgb(255, 255, 255); border-bottom: 2px solid rgb(255, 255, 255);" nowrap="nowrap">   
              <input name="tracking_number" style="color: rgb(0, 0, 0);" id="trackingBox" size="20" type="text">   
            </td>  
          </tr>  
          <tr>  
            <td nowrap="nowrap" valign="middle" width="1%">  
              <font size="2">  
                <b>Carrier:</b>  
              </font>  
            </td>  
            <td style="border-right: 2px solid rgb(255, 255, 255);" nowrap="nowrap">  
              <select name="carrier_select" style="color: rgb(0, 0, 0);" id="carrierSelect">  
                <option value="select" selected="selected">
                 Select ...  
                </option>   
                <option value="USPS">
                 USPS  
                </option>   
                <option value="DHL">
                 DHL  
                </option>   
                <option value="UPS">
                 UPS  
                </option>   
                <option value="Other">
                 Other  
                </option>   
                <option value="FedEx">
                 FedEx  
                </option>   
              </select>  
            </td>  
          </tr>     
        </tbody> 
      </table></td>';
  }
?>
<!-- *** END GOOGLE CHECKOUT *** -->
          </tr>
        </table></td>


  ----------------------------------------------------------------------------
  3b. /catalog/admin/orders.php                                        LINE 40
  ============================================================================
  
  REPLACE:

        if ( ($check_status['orders_status'] != $status) || tep_not_null($comments)) {
          tep_db_query("update " . TABLE_ORDERS . " set orders_status = '" . tep_db_input($status) . "', last_modified = now() where orders_id = '" . (int)$oID . "'");

          $customer_notified = '0';
          if (isset($HTTP_POST_VARS['notify']) && ($HTTP_POST_VARS['notify'] == 'on')) {
            $notify_comments = '';
            if (isset($HTTP_POST_VARS['notify_comments']) && ($HTTP_POST_VARS['notify_comments'] == 'on')) {
              $notify_comments = sprintf(EMAIL_TEXT_COMMENTS_UPDATE, $comments) . "\n\n";
            }

            $email = STORE_NAME . "\n" . EMAIL_SEPARATOR . "\n" . EMAIL_TEXT_ORDER_NUMBER . ' ' . $oID . "\n" . EMAIL_TEXT_INVOICE_URL . ' ' . tep_catalog_href_link(FILENAME_CATALOG_ACCOUNT_HISTORY_INFO, 'order_id=' . $oID, 'SSL') . "\n" . EMAIL_TEXT_DATE_ORDERED . ' ' . tep_date_long($check_status['date_purchased']) . "\n\n" . $notify_comments . sprintf(EMAIL_TEXT_STATUS_UPDATE, $orders_status_array[$status]);

            tep_mail($check_status['customers_name'], $check_status['customers_email_address'], EMAIL_TEXT_SUBJECT, $email, STORE_OWNER, STORE_OWNER_EMAIL_ADDRESS);

            $customer_notified = '1';
          }

          tep_db_query("insert into " . TABLE_ORDERS_STATUS_HISTORY . " (orders_id, orders_status_id, date_added, customer_notified, comments) values ('" . (int)$oID . "', '" . tep_db_input($status) . "', now(), '" . tep_db_input($customer_notified) . "', '" . tep_db_input($comments)  . "')");

          $order_updated = true;
        }

  WITH:

        if ( ($check_status['orders_status'] != $status) || tep_not_null($comments)) {
          tep_db_query("update " . TABLE_ORDERS . " set orders_status = '" . tep_db_input($status) . "', last_modified = now() where orders_id = '" . (int)$oID . "'");

          // *** BEGIN GOOGLE CHECKOUT ***
          chdir("./..");
          require_once(DIR_WS_LANGUAGES . $language . '/modules/payment/googlecheckout.php');
          $payment_value= MODULE_PAYMENT_GOOGLECHECKOUT_TEXT_TITLE;
          $num_rows = tep_db_num_rows(tep_db_query("select google_order_number from google_orders where orders_id= ". (int)$oID));

          if ($num_rows != 0) {
            $customer_notified = google_checkout_state_change($check_status, $status, $oID, 
                (@$_POST['notify']=='on'?1:0), 
                (@$_POST['notify_comments']=='on'?$comments:''));
          }
          $customer_notified = isset($customer_notified)?$customer_notified:'0';
          if (isset($_POST['notify']) && ($_POST['notify'] == 'on')) {
            $notify_comments = '';
            if (isset($HTTP_POST_VARS['notify_comments']) && ($HTTP_POST_VARS['notify_comments'] == 'on')) {
              $notify_comments = sprintf(EMAIL_TEXT_COMMENTS_UPDATE, $comments) . "\n\n";
            }
            $force_email = false;
            if ($num_rows != 0 && (strlen(htmlentities(strip_tags($notify_comments))) > GOOGLE_MESSAGE_LENGTH && MODULE_PAYMENT_GOOGLECHECKOUT_USE_CART_MESSAGING == 'True')) {
              $force_email = true;
              $messageStack->add_session(GOOGLECHECKOUT_WARNING_SYSTEM_EMAIL_SENT, 'warning');          
            }

            if ($num_rows == 0 || $force_email) {
              // send emails, not a google order or configured to use both messaging systems
              $email = STORE_NAME . "\n" . EMAIL_SEPARATOR . "\n" . EMAIL_TEXT_ORDER_NUMBER . ' ' . $oID . "\n" . EMAIL_TEXT_INVOICE_URL . ' ' . tep_catalog_href_link(FILENAME_CATALOG_ACCOUNT_HISTORY_INFO, 'order_id=' . $oID, 'SSL') . "\n" . EMAIL_TEXT_DATE_ORDERED . ' ' . tep_date_long($check_status['date_purchased']) . "\n\n" . $notify_comments . sprintf(EMAIL_TEXT_STATUS_UPDATE, $orders_status_array[$status]);
              tep_mail($check_status['customers_name'], $check_status['customers_email_address'], EMAIL_TEXT_SUBJECT, $email, STORE_OWNER, STORE_OWNER_EMAIL_ADDRESS);
              $customer_notified = '1';
              // send extra emails
            }
          }
          // *** END GOOGLE CHECKOUT ***

          tep_db_query("insert into " . TABLE_ORDERS_STATUS_HISTORY . " (orders_id, orders_status_id, date_added, customer_notified, comments) values ('" . (int)$oID . "', '" . tep_db_input($status) . "', now(), '" . tep_db_input($customer_notified) . "', '" . tep_db_input($comments)  . "')");

          $order_updated = true;
        }


  ----------------------------------------------------------------------------
  3c. /catalog/admin/orders.php                                        LINE 14
  ============================================================================
  
  ADD:

  // *** BEGIN GOOGLE CHECKOUT ***
  require_once(DIR_FS_CATALOG . 'googlecheckout/inserts/admin/orders.php');
  // *** END GOOGLE CHECKOUT *** 
  
  
  ----------------------------------------------------------------------------
  4. /catalog/checkout_payment.php                                    LINE 224
  ============================================================================
  
  REPLACE:

  $selection = $payment_modules->selection();

  WITH:

  // *** BEGIN GOOGLE CHECKOUT ***
  // Skips Google Checkout as a payment option on the payments page since that option
  // is provided in the checkout page.
  $selection = $payment_modules->selection();
  for ($i = 0, $n = sizeof($selection); $i < $n; $i++) {
    if ($selection[$i]['id'] == 'googlecheckout') {
      array_splice($selection, $i, 1);
      break;   
    }
  }
  // *** END GOOGLE CHECKOUT ***


  ----------------------------------------------------------------------------
  5. /catalog/login.php                                               LINE 203
  ============================================================================
  
  REPLACE:

                        <td align="right"><?php echo tep_image_submit('button_login.gif', IMAGE_BUTTON_LOGIN); ?></td>
                        <td width="10"><?php echo tep_draw_separator('pixel_trans.gif', '10', '1'); ?></td>
                      </tr>
                    </table></td>
                  </tr>
                </table></td>
              </tr>
            </table></td>
          </tr>
        </table></td>
      </tr>
    </table></form></td>

  WITH:

                        <td align="right"><?php echo tep_image_submit('button_login.gif', IMAGE_BUTTON_LOGIN); ?></td>
                        <td width="10"><?php echo tep_draw_separator('pixel_trans.gif', '10', '1'); ?></td>
                      </tr>
                    </table></td>
                  </tr>
                </table></td>
              </tr>
            </table></td>
          </tr>
        </table>
<?php
          // *** BEGIN GOOGLE CHECKOUT ***
          // Checks if the Google Checkout payment module has been enabled and, if so, 
          // includes gcheckout.php to add the Checkout button to the page.
          if (defined('MODULE_PAYMENT_GOOGLECHECKOUT_STATUS') && MODULE_PAYMENT_GOOGLECHECKOUT_STATUS == 'True') {
            include_once('googlecheckout/gcheckout.php');
          }
          // *** END GOOGLE CHECKOUT *** 
?>
        </td>
      </tr>
    </table></form></td>


  ----------------------------------------------------------------------------
  6. /catalog/shopping_cart.php                                       LINE 202
  ============================================================================
  
  REPLACE:

                <td align="right" class="main"><?php echo '<a href="' . tep_href_link(FILENAME_CHECKOUT_SHIPPING, '', 'SSL') . '">' . tep_image_button('button_checkout.gif', IMAGE_BUTTON_CHECKOUT) . '</a>'; ?></td>
                <td width="10"><?php echo tep_draw_separator('pixel_trans.gif', '10', '1'); ?></td>
              </tr>
            </table></td>
          </tr>
        </table></td>
      </tr>

  WITH:

                <td align="right" class="main"><?php echo '<a href="' . tep_href_link(FILENAME_CHECKOUT_SHIPPING, '', 'SSL') . '">' . tep_image_button('button_checkout.gif', IMAGE_BUTTON_CHECKOUT) . '</a>'; ?></td>
                <td width="10"><?php echo tep_draw_separator('pixel_trans.gif', '10', '1'); ?></td>
              </tr>
            </table></td>
          </tr>
        </table>
        </form>
<?php
          // *** BEGIN GOOGLE CHECKOUT ***
          // Checks if the Google Checkout payment module has been enabled and, if so, 
          // includes gcheckout.php to add the Checkout button to the page.
          if (defined('MODULE_PAYMENT_GOOGLECHECKOUT_STATUS') && MODULE_PAYMENT_GOOGLECHECKOUT_STATUS == 'True') {
            include_once('googlecheckout/gcheckout.php');
          }
          // *** END GOOGLE CHECKOUT ***
?>         
        <form></td>
      </tr>
